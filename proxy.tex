\chapter{プロキシ暗号}
\label{chap:proxy}
情報漏洩を心配して手元でデータを暗号化してからクラウドサーバに置きます。
一人でデータを利用しているのならよいのですが、複数人でデータをやりとりする場合はその暗号化に使った鍵を別途共有する必要があります。
この問題を解決する一つの方法がプロキシ暗号です。

\section{概要}
プロキシ暗号は、代理暗号、代理人暗号、再暗号化、代理人再暗号化などともいう暗号技術です。
英語ではProxy Re-Encryption（PRE）といいます。

Aさんが仕事で扱っているメールがあります。
AのメールサーバにあるデータはAの公開鍵で暗号化されています。
Aの休暇中にBが代わりにそのデータを扱うことになりました。

Aの秘密鍵をBに渡すのは好ましくありません。
そうするとAはサーバからデータをダウンロードし、自身の秘密鍵で復号して
Bの公開鍵で暗号化し、再度サーバにアップロードしなくてはなりません。
データを共有したい人が増えるとこれは大変です。
\image{proxy0.pdf}{暗号化データを共有したい}
プロキシ暗号を使うとサーバ上でデータを復号しなくてもBが復号できるように変換できます。
その作業をサーバに委ねることができるのでプロキシ（代理人）暗号といいます。

AはBの公開鍵暗号$K_B$と自身の秘密鍵$S_A$から再暗号化鍵$R_{A\rightarrow B}$を作ります。
再暗号化鍵を使うと、平文$m$をAの公開鍵で暗号化した暗号文$c:=\Enc(K_A,m)$をBの秘密鍵で復号できるように変換できます。
\begin{align*}
&\REnc(R_{A\rightarrow B}, \Enc(K_A,m))=\Enc(K_B,m), \quad \tt{すなわち}\\
&\REnc(R_{A\rightarrow B}, c)=\Enc(K_B,\Dec(P_A,c)).
\end{align*}
あたかも、一度Aの秘密鍵で復号してBの公開鍵で暗号化したかのように見えるのがポイントです。
なお、後述するように再暗号化する前とした後で暗号方式が異なることがあります。
\image{proxy.pdf}{プロキシ暗号}

\section{最初の方式}
1996年、満保雅浩氏、岡本栄司氏が代理署名という概念を提案し、1998年、Blaze,  Bleumer, Straussが原子的プロキシ暗号（Atomic Proxy Cryptography）を提案します~\cite{Blaze98divertibleprotocols}。
原子的というのは復号と再暗号化を分離せずに一つの処理として行うという意味です。
これはElGamal暗号を変形したものでした。
\mydescription{
\item[鍵生成]
乗法的巡回群$G:=\gen{g}$をとり$g$を公開する。
Aは整数$a$をランダムに選んで秘密鍵とし$g^a$を公開鍵とする。
Bも同様に$b$を秘密鍵、$g^b$を公開鍵とする。$r_{A \rightarrow B}:=b/a$を再暗号化鍵とする。
\item[暗号化]
Aは平文$m$に対して整数$r$をランダムに選び
\[
c_a:=(mg^r, g^{ar})
\]
を暗号文とする。
\item[通常の復号]
暗号文$c_a=(u,v_a)$に対して
\[
\frac{u}{(v_a)^{1/a}}=\frac{mg^r}{(g^{ar})^{1/a}}=\frac{mg^r}{g^r}=m
\]
と復号する。
\item[再暗号化]
暗号文$c_a=(u,v_a)$に対して$r_{A \rightarrow B}$を用いて
\[
c_b:=(u, v_a^{r_{A \rightarrow B}})
\]
とする。
}
再暗号化された$c_b=(u,v_b)$は
\[
v_b:=v_a^{r_{A \rightarrow B}} = (g^{ar})^{b/a}=g^{br}
\]
となりBの秘密鍵$b$を用いて
\[
\frac{u}{(v_b)^{1/b}}=\frac{mg^r}{(g^{br})^{1/b}}=\frac{mg^r}{g^r}=m
\]
と復号できます。

この方式はいくつか欠点があります。
まず再暗号化鍵$r_{A \rightarrow B}=b/a$をどうやって作るかという問題です。
AやBが$r_{A \rightarrow B}$を知ってしまうと相手の秘密鍵がわかってしまうので別の誰かに$a$と$b$をそれぞれ教えて$b/a$を計算してからプロキシにのみこっそり教えるしかありません。
あまり嬉しくありませんね。

それからプロキシとAが結託するとBの秘密鍵$b$がわかります（AとBを入れ換えても同様）。
これを結託攻撃といいます。
それからプロキシは$b/a$から$a/b$を計算できるのでBの暗号文をAが復号できるようにも再暗号化できます。
これは利点のときもありますが、Bが許可したつもりのない操作かもしれません。

\section{改良方式}\label{proxy}
2006年Atenieseたちは前節の方式を改良し、DBDH仮定のもとでプロキシと自分以外の人による結託攻撃ができない方式を提案します~\cite{Ateniese:2006}。
これは秘密鍵の受け渡しが不要なものでした。
\mydescription{
\item[鍵生成]
$E$を楕円曲線、$P$をその上の点、$e:E \times E \rightarrow G$を対称ペアリングとする。
$g:=e(P,P) \in G$とし$P$や$g$を公開する。
Aは整数$a$をランダムに選び秘密鍵とし、$aP$を公開鍵とする。
Bも$b$を秘密鍵、$bP$を公開鍵とする。
\item[再暗号化鍵生成]
Aは自身の秘密鍵$a$とBの公開鍵$bP$を用いて
\[
r_{A \rightarrow B}:=(1/a)(bP)=(b/a)P
\]
を求める。
\item[暗号化]
Aは整数$r$をランダムに選び
\[
c_a:=(mg^r, r(aP))
\]
を暗号文とする。
\item[通常の復号]
暗号文$c_a:=(u,V_a)$に対して
\[
\frac{u}{e(V_a,(1/a)P)}=\frac{mg^r}{e(raP,(1/a)P)}=\frac{mg^r}{e(P,P)^r}=\frac{mg^r}{g^r}=m
\]
と復号する。
\item[再暗号化]
暗号文$c_a:=(u,V_a)$に対して
\[
e(V_a,r_{A \rightarrow B})=e(raP, (b/a)P)=e(P,P)^{rb}=g^{rb}
\]
とし、再暗号化文を$(u, g^{rb})$とする。
二つ目の元はペアリングをとることで楕円曲線の点から有限体の元になったことに注意してください。
\item[再暗号化された暗号文の復号]
再暗号化された$c_b=(u, v_b)$に対してBの秘密鍵$b$を用いて
\[
\frac{u}{v_b^{1/b}}=\frac{mg^r}{(g^{rb})^{1/b}}=\frac{mg^r}{g^r}=m
\]
とする。
}
この方式は最初の方式に比べていろいろ改善されています。
まず、再暗号化鍵は自分の秘密鍵と相手の公開鍵のみから作成できるので余計な秘密の通信がいりません。
それからプロキシとBが結託しても$(b/a)P$と$b$からは$a$を求めることができません。

更にプロキシは$P$と$(b/a)P$から$(a/b)P$をつくることができない（\ref{quiz}節参照）ので逆向きに利用されることがありません。
なお、これと異なりプロキシが$r_{A \rightarrow B}$と$r_{B \rightarrow A}$を相互に変換できる方式も提案されています。
どちらがよいかはアプリケーションによるでしょう。

また通常の暗号化と再暗号化で方式が異なるので再暗号化は一度しかできません。
したがってプロキシがAからBへの再暗号化鍵$r_{A \rightarrow B}$、BからCへの再暗号化鍵$r_{B \rightarrow C}$を持っていても、Aの暗号文をCが復号できるような再暗号化はできません。
これは復号可能な人を細かく制御できるというメリットがあります。

\section{その後の進展}
プロキシ暗号は様々な拡張が考えられます。
たとえば再暗号化鍵に有効期間を設ける、メンバーの削除時に再暗号化鍵を無効化する、別の暗号方式にプロキシ暗号の機能を持たせるなどです。

ただプロキシ暗号は通常の暗号化、復号の他に再暗号化鍵、再暗号化する前後の暗号文などたくさんの情報があります。
結託攻撃も複数のユーザによる結託だけでなく、プロキシが関わる結託攻撃もあります。
したがって安全性を厳密に定義し証明することが難しく、複雑な安全性仮定を置くこともあります。
そのため公開鍵暗号、電子署名や秘密分散といった基本的な技術を組み合わせてプロキシ暗号を構成して安心感を高める設計方式も提案されています~\cite{module}。

\section{この章のまとめ}
プロキシ暗号を紹介しました。
プロキシ暗号は、暗号文を復号することなく別の人が復号できる暗号文に変換する暗号です。
その再暗号の操作は変換鍵を委託された第三者が行えます。
そのためクラウドサービスと相性がよく、他の暗号と組み合わせた方式が考えられています。
