\chapter*{\ref{part:new}部の流れ}
\ref{part:base}部では共通鍵暗号や公開鍵暗号などの現在使われている技術の紹介をしました。
\ref{part:new}部では主に2000年以降に登場した新しい暗号技術と理論の紹介をします。

クラウドサービスが普及していますが全面的にクラウドを信用したいわけではありません。
従来の暗号技術は安全にデータをクラウドに置くことにのみ注力していました。
データをクラウドに置くことが一般化すると、今度はクラウドの資源使って暗号化したまま検索したい、計算したいといった要求が生じます。新しい暗号技術はそれらの要求に答えようとするものです。

\ref{chap:pairing}章では楕円曲線から有限体へのペアリングと呼ばれる写像を紹介します。
本書で紹介する新しい暗号技術のほとんどはペアリングを用いて実現されます。
まず公開鍵を自由な数値（ID）に設定できるIDベース暗号を作ります。
それから後はいくつかの暗号について個別に紹介します。
各章は概ね独立しているので興味を持った章から眺めてもよいでしょう。
各章では次の暗号を紹介します、

\ref{chap:search}章では暗号化したまま検索できる検索可能暗号。

\ref{chap:proxy}章では暗号文を復号することなく別の人向けの暗号文を作り出すプロキシ暗号。

\ref{chap:broadcast}章では沢山の人に安全に効率よく暗号文を配信する放送型暗号。

\ref{chap:abe}章では復号できる条件を自由に指定できる属性ベース暗号。

\ref{chap:fe}章では属性ベース暗号をより一般化した関数型暗号を紹介します。
属性ベース暗号や関数型暗号は一つ暗号鍵に複数の復号鍵が対応したり、複数の暗号鍵が一つの復号鍵に対応したりします。
公開鍵暗号やIDベース暗号を拡張した暗号技術です。

\ref{chap:homo}章ではデータを暗号化したまま復号することなくクラウドに計算させられる準同型暗号を紹介します。
様々な応用が考えられ、近年研究が盛んな分野です。

\ref{chap:zero}章ではゼロ知識証明を紹介します。
ゼロ知識証明は自分がある情報を知っているということをその情報を相手に教えないまま納得してもらう技術です。
ゼロ知識証明は暗号ではありませんが暗号と一緒に使うことで不正防止などを実現できます。

\ref{chap:assumption}章では暗号の安全性根拠となっている理論的な計算仮定をまとめます。

\chapter{ペアリングとIDベース暗号}
\label{chap:pairing}
2000年以降、従来の共通鍵暗号や公開鍵暗号とは異なる機能を持った暗号が提案されてきました。
IDベース暗号、放送型暗号、属性ベース暗号、関数型暗号などです。
この章ではそれらの暗号で使われる数学の道具の一つ、ペアリングという演算について説明します。
ペアリングを使った暗号は活発に研究され、実用化に向けた標準策定も進められています。

\section{ペアリング}
\index{ぺありんぐ@ペアリング}
ペアリングは楕円曲線$E$上の2個の点の組からある有限体$F_q$への写像です。
\[
e: E \times E \longrightarrow F_q.
\]
厳密な定義はかなりの数学的な準備を必要とするため\ref{chap:pairing_math}章で改めて紹介します。
ここでは直感的に理解しやすい幾何学的な描写をします。

楕円曲線上の2点$P$, $Q$が与えられると原点$O$, $P$, $Q$, $R:=P+Q$で作られた平行四辺形$OPRQ$が決まります。
この平行四辺形$OPRQ$の面積は2点$P$, $Q$で決まるので$S(P,Q)$と書くことにします。
なお、面積は符号付きで考えることにして$Q$が$O$を中心に$P$の反時計周りの方向にあるときを正、逆向きにあるときを負とします。
面積$S(P,Q)$を、有限体のある固定値$g$の指数に乗せたものがペアリングの値です。
\[
\begin{array}{cccc}
e:& E \times E       & \longrightarrow & F_q                     \\
&\rotatebox{90}{$\in$} &                 & \rotatebox{90}{$\in$} \\
&(P,Q)                 & \longmapsto     & g^{S(P,Q)}.
\end{array}
\]
$g$については後ほど触れます。
\image{pairing-def.pdf}{原点$O$と点$P$, $Q$から定まる平行四辺形$OPRQ$}
ペアリングの性質を調べましょう。
まず$P=Q$のときは平行四辺形がつぶれて面積が0になるのでペアリングの値は1になります。
\[
e(P,P)=1.
\]
点$P$, $Q$が与えられたとき、2点$2P$, $Q$で決まる平行四辺形の面積は$P$, $Q$で決まる平行四辺形の面積の2倍です。
\[
S(2P,Q)=2S(P,Q).
\]
\image{pairing2.pdf}{2倍点の作る平行四辺形}
ペアリングは面積を対応させる写像なので
\[
e(2P, Q) = g^{S(2P,Q)}=g^{2S(P,Q)}=\left(g^{S(P,Q)}\right)^2=e(P,Q)^2
\]
と元のペアリングの値の2乗になります。
一般に点$P$を整数$a$倍すると面積は$a$倍になるのでペアリングの値は$a$乗になります。
この性質は点$Q$の側についても成立します。
よって一般に整数$a$, $b$に対して
\[
e(aP,bQ)=e(P,Q)^{ab}
\]
が成立します。ペアリングを暗号に使うときに一番重要な関係式です。

\section{IDを使った鍵共有}
\label{ID-NIKS}
ID（identifier）とは自分を示す何らかの識別子のことです。
たとえば名前やメールアドレス、学生番号などが識別子になります。

1999年に大岸氏たちにより提案されたペアリングを使ったID鍵共有方式を紹介しましょう。
IDはユーザを区別する識別子なのでID $X$をもつユーザをユーザ$X$ということにします。
\mydescription{
\item[セットアップ]
鍵生成局が楕円曲線$E$と、IDの集合から$E$への中への1対1の関数
\[
H:\set{\texttt{ID}}\rightarrow E
\]
を決めて公開する。
ユーザ$X$に対して$P_X:=H(X)$とおく。
$P_X$は誰でも計算できる。
整数$s$をマスター秘密鍵とする。
\item[秘密鍵の生成]
生成局は、各ユーザ$X$に対して$K_X:=s P_X=s H(X)$を秘密鍵として渡す。
\item[鍵共有]
Aは秘密鍵$K_A$と、BのIDから求まる$P_B$を使って$s_A:=e(K_A, P_B)$を計算する。\\
Bは秘密鍵$K_B$と、AのIDから求まる$P_A$を使って$s_B:=e(P_A, K_B)$を計算する。
}
ペアリングのとり方の順序に注意します。
たとえばIDに順序関係を入れて小さい方の添え字を前にする（この場合は$A < B$）といった取り決めが必要です。
\begin{align*}
s_A &=e(K_A, P_B)=e(s P_A, P_B)=e(P_A, P_B)^s=e(P_A, s P_B)\\
&=e(P_A, K_B)=s_B
\end{align*}
が成立するので二人の間で秘密の値を共有できます。
このID鍵共有の安全性については後ほど触れるとして、ECDH鍵共有との違いを比べます。
\tablecap{ECDH鍵共有とID鍵共有の比較}{
\begin{tabular}{|c|c|c|c|}
\hline
           & 自分の秘密鍵 & 相手の公開情報 & 共有鍵 \\\hline
ECDH鍵共有 & $a$    & $bP$           & $abP$ \\\hline
ID鍵共有   & $sH(A)$ & $H(B)$ & $e(H(A), H(B))^s$ \\\hline
\end{tabular}
}
ECDH鍵共有では秘密鍵$a$や$b$を先に（自由に）決めてから、公開鍵$aP$や$bP$を作ります。
したがって、$aP$や$bP$を自分の狙った数値にできません。
それに対して、ペアリングを使ったID鍵共有では公開情報$A$や$B$を先に決めてから秘密鍵$sH(A)$や$sH(B)$を作ります。
そのため公開情報として自由なIDを使うことができます。

\section{3者間DH鍵共有}
\label{tdh}
2000年にJouxにより提案されたペアリングを用いた3者間での鍵共有~\cite{Joux}を紹介しましょう。
ほとんどの鍵共有法は2者間で行われます。
これは3者間で鍵共有を行う珍しいものです。

楕円曲線上の2点$P$, $Q$を固定して皆で共有します。
3人$A$, $B$, $C$はそれぞれ整数$a$, $b$, $c$を秘密鍵として
$(aP, aQ)$, $(bP, bQ)$, $(cP, cQ)$を公開します。
$A$は自身の秘密鍵$a$と$B$, $C$の公開鍵$bP$, $cQ$を使って
\[
e(bP, cQ)^a=e(P, Q)^{abc}
\]
を計算します。
$B$, $C$も同様に計算します。
\begin{align*}
B:\quad& e(aP, cQ)^b=e(P,Q)^{abc},\\
C:\quad& e(aP, bQ)^c=e(P,Q)^{abc}.
\end{align*}
3人同時に$e(P,Q)^{abc}$を共有することができました。
この方法はECDH鍵共有の素直な拡張に見えますね。
より一般に整数$a$, $b$, $\dots$と何かの点$P$, $Q$, $\dots$に対して
\[
f(aP,bQ, cR, dS, \dots)=f(P,Q,R,S, \dots)^{abcd \cdots}
\]
となる関数$f$（多重線形写像といいます）が見つかれば多人数での鍵共有ができそうです。
実際多重線形写像があると、効率のよい放送暗号や様々な興味深い暗号プロトコルが構成されることが知られています。
しかし残念ながら暗号に使えるそのような関数は今のところ構成されていません。
ただ2012年、Garg, Gentry, Haleviたちがイデアル格子というものを使って多重線形写像の候補となるものを構成しました~\cite{GGH}。
またCoron, Lepoint, Tibouchiたちは別の方式で構成しています~\cite{CLT}。
2015年初頭では処理速度や鍵長の観点からまだまだ実用的とはいえませんが今後の発展が望まれます。
\section{双線形と非対称}
これからペアリングを使った暗号プロトコルを紹介します。
ただその前にもうしばらくペアリングの性質について調べましょう。
楕円曲線上の点を2個の基底ベクトル$\vec{e}_1$, $\vec{e}_2$を使って表現します。
\image{base.pdf}{楕円曲線上の点の基底ベクトルを使った表現}
任意の2個の点$P$, $Q$を整数$a$, $b$, $c$, $d$を使ってそれぞれ
\begin{align*}
&P:=a\vec{e}_1+b\vec{e}_2,\\
&Q:=c\vec{e}_1+d\vec{e}_2
\end{align*}
とします。
すると平行四辺形の4個の座標は$(0,0)$, $(a, b)$, $(a+c, b+d)$, $(c,d)$です。
この平行四辺形の面積$S(P,Q)$を求めます。
まず三角形$OPQ$をぴったり囲む長方形$OSTU$を考えます。
ここで$S=(a,0)$, $T=(a,d)$, $U=(0,d)$です。
三角形$OPQ$の面積$S'$は、長方形$OSTU$の面積から3個の三角形$X:=\triangle OSP$, $Y:=\triangle OQU$, $Z:=\triangle PTQ$の面積を引いたものです。
\image{area.pdf}{三角形$OPQ$と平行四辺形$OPRQ$}
3個の三角形の面積はそれぞれ
\[
X\text{の面積} = \half ab, \quad Y\text{の面積} = \half cd, \quad Z\text{の面積} = \half (a-c)(d-b).
\]
よって
\[
S'=ad-\half ab - \half cd - \half (a-c)(d-b)=\half(ad-bc)
\]
となり、平行四辺形$OPRQ$の面積はその2倍なので$S(P,Q)=2S'=ad-bc$です。
単位ベクトル$\vec{e}_1$と$\vec{e}_2$のペアリングの値を$g:=e(\vec{e}_1,\vec{e}_2)$とすると$P$と$Q$のペアリングの値は
\[
e(P, Q)=g^{ad-bc}
\]
となります。
\image{pairing.pdf}{ペアリングの図形的な意味}
特に
点$P_1=a_1\vec{e}_1+b_1\vec{e}_2$,
$P_2=a_2\vec{e}_1+b_2\vec{e}_2$について$P_1+P_2=(a_1+a_2)\vec{e}_1+(b_1+b_2)\vec{e}_2$。
よって
\[
e(P_1+P_2,Q)=g^{(a_1+a_2)c-(b_1+b_2)d}=g^{(a_1c-b_1d)+(a_2c-b_2d)}=e(P_1,Q)e(P_2,Q)
\]
が成立します。点の和のペアリングはそれぞれのペアリングの積になっています。
点$Q_1$, $Q_2$に関しても同様に
\[
e(P,Q_1+Q_2)=e(P,Q_1)e(P,Q_2)
\]
が成立します。
これらの性質を双線形（bilinear）といいます。
$P$についても$Q$についても線形（linear）だからです。
右辺が値の和$e(P,Q_1)+e(P,Q_2)$ではなく値の積$e(P,Q_1)e(P,Q_2)$なのですが慣習的に線形と呼んでいます。
それでペアリングのことを双線形写像（bilinear map）ともいいます。

最後に点$P$と$Q$を入れ換えるとどうなるか調べます。
$P$と$Q$を入れ換えると$(a,b)$と$(c,d)$がひっくり返るので
\[
e(Q,P)=g^{cd-ab}=\left(g^{ad-bc}\right)^{-1}=e(P,Q)^{-1}.
\]
図形的には平行四辺形の面積がひっくり返って符号が変わったと解釈できます。

\section{対称ペアリングと非対称ペアリング}
前述で紹介したペアリングはWeilペアリングと呼ばれ任意の点$P$に対して$e(P,P)=1$です。

ペアリングが暗号を構成するのに重要だと認識されると、どんな楕円曲線やペアリングなら効率よく計算できるのか研究されました。
$P$と$Q$が異なる楕円曲線上の点となるペアリングも構成されています。
ある種の楕円曲線には楕円曲線のある点$P$の巡回群$\gen{P}:=\Set{nP|n \in \ZZ}$に含まれない別の点$Q$に移す線形写像$\psi$が存在します。
$\psi$は線形写像なので整数$a$に対して
\[
\psi(aP)=a\psi(P)=aQ
\]
が成立します。
$\psi$をdistortion写像といいます。2001年Boneh, Franklinが提案しました~\cite{BF}。

$\psi$を使って任意の$P$の倍数$aP$, $bP$に対して写像$e':\gen{P} \times \gen{P} \rightarrow F_q$を
\[
e'(aP, bP):=e(aP, \psi(bP))
\]
と定義します。片方の点をdistortion写像で移してからペアリングをとるのです。
\image{distortion.pdf}{distortion写像}
すると$e'(P,P)=e(P,Q)\ne 1$です。
また$\psi$の線形性と$e$の双線形性から
\[
e'(aP, bP)=e(aP, \psi(bP))=e(aP, b\psi(P))=e(P, \psi(P))^{ab}=e'(P,P)^{ab}
\]
という関係式が成立します。
特に$e'(aP,bP)=e'(bP, aP)$です。
$aP$と$bP$を交換してもペアリングの値は同じなので$e'$を対称ペアリング、あるいはtype Iのペアリングといいます。

それに対してdistortion写像のような片方からもう片方への写像がないペアリングをtype IIIといいます。
distortion写像があっても逆向きの写像が簡単には計算できないときはtype IIペアリングです。
type IIとtype IIIを合わせて非対称ペアリングといいます。

非対称ペアリングは異なる楕円曲線の2点$P$, $Q$が必要なのに対して、
対称ペアリングは1点$P$だけあればよく、必要なパラメータの数が少なくなります。
ペアリングを使った暗号プロトコルではパラメータの数が少ない方がなにかと便利なので対称ペアリングがよく使われます。

たとえば\ref{tdh}節で紹介した3者間DH鍵共有は対称ペアリング$e'$を使うと次のようになります。
楕円曲線上の点$P$を固定してみなで共有します。
3人$A$, $B$, $C$はそれぞれの整数$a$, $b$, $c$を秘密鍵として
$aP$, $bP$, $cP$を公開します。
3人は
\begin{align*}
A:\quad& e'(bP, cP)^a=e'(P,P)^{abc},\\
B:\quad& e'(aP, cP)^b=e'(P,P)^{abc},\\
C:\quad& e'(aP, bP)^c=e'(P,P)^{abc}
\end{align*}
により鍵共有を行います。
共有、転送すべきパラメータが減ったのと、ペアリングの順序を気にしなくてよいのですっきりしますね。
本書でも以降、対称ペアリングを前提とし記号も$e'$ではなく$e$と書くことにします。

ただ2012年頃から対称ペアリングでよく使われていた曲線に対するDLPを解く方法が大きく進展しました~\cite{adj2014weakness}。
したがって実際に使う場合は非対称ペアリングを用いる方が多いと思われます。

なお暗号の教科書や論文では、巡回群$\gen{P}$を$G$と書き、楕円曲線上の点の足し算演算を乗法表記するのが主流です。
これは有限体や楕円曲線などの具体的なものではなく、巡回群$G$があれば暗号プロトコルを考えることができるという抽象化の流れの一環です。
たとえば対称ペアリングの関係式は$a$, $b$を整数、$g \in G$として
\[
e:G \times G \ni (g^a, g^b) \longmapsto e(g,g)^{ab} \in G
\]
と書きます。
本書では演算が楕円曲線の足し算というのを強調したいのと、乗法表記すると指数が小さくなって読みにくくなることが多いと思うので加法表記にしています。

\section{DLPとECDLPとペアリング}
\label{relation}
ペアリングは有限体と楕円曲線をつなぐ架け橋になっています。
ペアリングが満たす関係式を再度記してそのことを確認します。
$P$を楕円曲線上の点、$a$, $b$を整数、$g:=e(P,P)$としたとき
\[
e(aP,bP)=g^{ab}
\]
が成立するのでした。
$P$と$b$を固定して$a$だけ動かしてみましょう。
\[
f: E \ni X \mapsto e(X, bP) \in \FF_q
\]
という写像を考えることになります。
この$f$を$e(\cdot, bP)$と書くことにします。
一つ目の$\cdot$の部分に楕円曲線の点を入れて値を確定させてねという意味です。
すると
\[
f(aP)=e(aP, bP)=e(P, bP)^a=f(P)^a
\]
なので楕円曲線上の$a$倍が有限体上の$a$乗に対応していることがわかります。
\image{mov.pdf}{点の$a$倍と$a$乗とペアリングの関係}
ここで$P$と$aP$が与えられたとします。
するとペアリング$e(\cdot, bP)$を作用させることで$h:=e(P,bP)=g^b$と$e(aP,bP)=g^{ab}=h^a$を求められます。
もし、$h$と$h^a$から$a$を求められたなら、
元の楕円曲線上の離散対数問題が解けたことになります。
\image{mov2.pdf}{MOVリダクション}
つまりECDLPをDLPに帰着できるということです。
1990年、この考え方によるECDLPの攻撃が提案されました。
MOVリダクション（Menezes, Okamoto, Vanstone）と呼ばれます。
最初、ペアリングは楕円暗号を攻撃するための道具として利用されたのでした。

私は1999年頃暗号に興味を持ち、当時の京都工芸繊維大学の笠原研究室にお伺いしていました。
暗号のことを教えていただきながら代わりに私はペアリングの数学的な定義などの解説をしました。
そうした中で研究室の方がこのペアリングを暗号に使うことを思いつきます。
暗号を破るために使われた手法を、新しい暗号を作るために使おうという発想です。
ECDLPがDLPに帰着されるということですが、逆に言えばそのDLPが困難ならECDLPも困難でしょう。

話を戻してもう一度式を見直します。
$aP$や$bP$があったときにECDH仮定により$abP$を求めるのは困難です。
また$g$, $g^a$, $g^b$が与えられてもDH仮定により$g^{ab}$を求めるのは困難です。
\image{dh-oracle.pdf}{DH, ECDH, ペアリングの関係}
しかし、$aP$と$bP$があったときにペアリングを使うとまるでDH問題を解いたかのように$g^{ab}$を計算できます。
つまりペアリングを使うと一度だけDH問題を解く手段を手に入れたと解釈できます。

\section{IDベース暗号}
\label{ID-base}
IDベース暗号とは公開鍵に自分の好きな文字列IDを選べる暗号のことです。
たとえば自分のメールアドレスを自分の公開鍵として使うことができます。
他の人がAさんに暗号文を送信したければ、Aさんのメールアドレスと自分の秘密鍵を使って暗号文を生成できます。
従来の公開鍵暗号では公開鍵が本当にその本人のものであるという認証が必要でした。
メールアドレスは普段使っているものですから、間違えようがありません。

IDベース暗号の概念自体は1980年代からあったのですが、実際にどうすれば効率のよいものが作れるかわかっていませんでした。
ペアリングを使った手法が提案されることで実際に使えるものとなり始めたのです。

まずペアリングを使ったIDベース暗号の一つを紹介します。
これは大岸、境、笠原、Boneh, Franklinたちによるものです。
\label{OSK-BF}
\ref{ID-NIKS}節で紹介したIDを使った鍵共有のアイデアを使っています。
\mydescription{
\item[セットアップ]
鍵生成局が楕円曲線$E$、IDの集合から$E$へのハッシュ関数$H_1:\set{\texttt{ID}}\rightarrow E$、
$E$から有限体へのハッシュ関数$h_2:E \rightarrow \FF_q$を決めて公開する。
ユーザ$X$に対して$P_X:=H_1(X)$とおく。$P_X$は誰でも計算できる。整数$s$をマスター秘密鍵とする。
楕円曲線$E$上の点$P$と$sP$を公開する。
\item[秘密鍵の生成]
生成局はユーザ$X$に対して$K_X:=s P_X$を秘密鍵として渡す。
\item[暗号化] ユーザAに対して平文$m$を暗号化するには乱数$r$をとり
\[
\Enc(m):=(rP, m \oplus h_2(e(P_A, sP)^r))
\]
を暗号文とする。
\item[復号]
ユーザAは暗号文$C:=(U, v)$を受け取り
\[
\Dec(U, v):=v \oplus h_2(e(K_A, U))
\]
で復号する。
}
ペアリングの性質から
\[
e(P_A, sP)^r=e(P_A,P)^{sr}=e(sP_A,rP)=e(K_A,rP)
\]
が成立します。
すると平文$m$を暗号化してから復号すると
\begin{align*}
\Dec(\Enc(m))&=\Dec((U, v))=v \oplus h_2(e(K_A,U))\\
&=(m \oplus h_2(e(P_A,sP)^r)) \oplus h_2(e(K_A,rP))\\
&=(m \oplus h_2(e(K_A,rP))) \oplus h_2(e(K_A,rP)) =m
\end{align*}
となり正しく復号できます。
このIDベース暗号は、CBDH（Computational Bilinear Diffie-Hellman）仮定、他にいくつかの仮定のもとで安全とされています。
CBDH仮定とは次のCBDH問題と呼ばれる問題が難しいという仮定です。
単にBDH問題ともいわれます。

「楕円曲線上の点$P$と整数$a$, $b$, $c$に対して$(P, aP, bP, cP)$が与えられたときに$e(P,P)^{abc}$を求めよ。」

その後、より安全なバージョンや効率のよい方法などがいろいろ提案されています。
CRYPTREC報告書の2008年度「IDベース暗号に関する調査報告書」~\cite{cryptrec2008}の1章では様々な方式が、2章では様々な安全性仮定が紹介されています。
補遺\ref{assumption_list}にて本書に登場する安全性仮定をまとめています。

\section{IDベース暗号と公開鍵暗号の違い}
ID（公開鍵）としてメールアドレスを使えば公開鍵が本人のものであることは間違いないと思われます。
とすると公開鍵暗号で面倒なPKIは不要となり、これからはIDベース暗号に置き換わっていくものなのでしょうか。
実はそんなに簡単なものではありません。

まず、IDベース暗号だと鍵生成局はマスター鍵を持っているのでどの人の秘密鍵も作成できます。
これは相当強い権限ですね。
またマスター鍵が漏洩すると全ての人の鍵が判明してしまいます。
この問題に対しては生成局を分散化する方式が提案されています。
そうすると、たとえ一つの生成局が不正をしても安全性は保たれます。

また鍵生成局はユーザから依頼されたときにその人のIDに対する秘密鍵を渡します。
それにはIDに対する本人確認と秘密鍵を渡すための安全な通信経路が必要でしょう。

鍵の失効に関する問題もあります。何らかの不手際で万一自分の秘密鍵が漏れてしまったとします。
従来の公開鍵暗号では新しい鍵を作り直して認証局に鍵の失効手続きをすればよいです。
しかし、IDベース暗号で自分のアドレスを使っていた場合はどうすればよいでしょうか。
自分のメールアドレスを変えるのはなかなか不便です。
銀行の通帳や車の免許証のようにメールアドレスの末尾に発行回数を追加しておくという手はあります。
あるいは鍵の有効期間をIDに含めてもよいです。
いずれにせよ古い番号のものが失効されたかどうかを確認するにはPKIのような鍵の管理システムが必要になります。
そこでPKIとIDベース暗号の長所を組み合わせた証明書ベースの暗号方式や証明書不要の方式が提案されています。

というように実際に運用を考えるといろいろな枠組みが必要であることに気づきます。
とはいえ、IDベース暗号は従来の公開鍵暗号では実現できない機能をいろいろ持っています。
たとえばメールアドレスをIDとするIDベース暗号が運用されていたとすると、
ある人のメールアドレスだけでその人に秘密の文章を送れます。
その人がまだIDベース暗号のシステムに加入していなくても暗号化できるのです。
受け取った人は、その文章を読みたければそこで初めて鍵生成局に自身の秘密鍵を申請して復号します。
なんだか加入が強制されて気持ち悪いですが暗号化が先にできるというのは面白いですね。

\section{タイムリリース暗号}
IDベース暗号のIDとして時刻を使うと何ができるでしょうか。前節最後の秘密鍵がなくても暗号化が先にできるという話が生きてきます。
タイムリリース暗号というものを紹介しましょう。
これは決められた時刻になるまでは復号できないことを保証する暗号方式です。

会社の投資家向けの情報（IR情報）について考えてみます。
IR情報は株価を左右するかもしれない重要な情報です。
IR情報の公開前に証券会社がその情報を利用してインサイダー取引などの不公平な株の取引が行われてる事件があります。
これに対処するために会社はその情報をたとえば午後3時を指定して暗号化し直接投資家に配布する方法が考えられます。
\image{timecapsule.pdf}{タイムリリース暗号}
既存の枠組みでこのような機能を持ったシステムはどうやって作るか考えてみましょう。
まず、復号側で決められた時刻になったことを知る必要があります。
そのデバイスの内蔵時計を見ればよい？\,
その時刻を勝手に変更されてしまう危険性があります。
とするとインターネットか電波経由で正しい時刻になったことをその都度確認しなければなりません。
これは論理的に必要な条件です。

さて、正しい時刻になったことを確認すれば復号を開始するわけですが、復号鍵を事前に持っていると悪意ある復号者が時刻とは無関係にその鍵を見つけてしまう恐れがあります。
DRM（デジタル著作権管理）ソフトはそのようなことができないよう、耐タンパー性技術を用いて復号鍵を隠し持たせることがあります。
しかし耐タンパー性を信用できなければ、結局その時刻になったら復号鍵をもらうという単純な方式に落ちつきます。

これに対してタイムリリース暗号は次のような形になります。
鍵生成局は正しい時刻を配信する時刻センターが担います。
\mydescription{
\item[セットアップ]
時刻センターは整数$s$と楕円曲線$E$とその点$P$を選び$(P, sP)$を公開する。
$s$を秘密鍵とする。$H$を時刻$T$から$E$へのハッシュ関数とする。
時刻センターは一定間隔（たとえば1秒）で現在時刻$T$と$sH(T)$の組$(T, sH(T))$を配信する。
\item[暗号化]
あるユーザが時刻$T_0$になるまで平文$m$を復号させたくないとする。
乱数$r$を選び$s_{T_0}=e(H(T_0), rsP)$を計算する。$s_{T_0}$で$m$を暗号化した$\Enc(s_{T_0},m)$と$rP$を配信する。
\item[復号]
時刻$T_0$に時刻センターから$sH(T_0)$を受け取るので$e(sH(T_0), rP)=s_{T_0}$を計算し$m$を復号する。
}
時刻$T$に時刻センターから鍵に相当する$sH(T)$をもらうのですから、
一見先ほど考察した従来の方式とあまり変わらないように見えます。
しかしその場合、暗号化する人それぞれが鍵を復号したい人に渡す必要がありました。
タイムリリース暗号では暗号化する人は時刻$T$に何か行動を起こす必要はありません。
時刻センターが不特定多数に一度に$sH(T)$を配信するだけです。
復号時刻が同じ複数の暗号文を一つの$(T, sH(T))$で復号できます。
この点が大きな違いです。

また時刻$T$に受け取った$Q=sH(T)$が正しいものかどうかを確認するには公開情報$P$と$sP$を使って
\[
e(Q, P) = e(H(T), sP)
\]
の等号成立を確認すればできます。つまり時刻センターは署名付きの時刻を配信しているだけと考えることもできます。
既に電子取引のために正確な時刻を提供するサービスはあります。そのサービス提供者がこの署名付きの時刻配信を担うとよいように思います。

この形のタイムリリース暗号では時刻$T_0$になると不特定多数の人が復号できます。
最初に述べた会社のIR情報を配信したい場合はこの機能で十分でしょう。
しかし特定の人にのみ復号したい場合はこの方式を拡張する必要があります。

\section{ペアリングを使ったデジタル署名}
\label{shortSig}
タイムリリース暗号である時刻に対する復号鍵の正当性を確認できて署名の役割を果たしました。
一般にIDベース暗号ではIDとしてメッセージを選ぶとその復号鍵は署名の役割を持つことがわかります。
この考え方でいくつか効率のよいデジタル署名が構成されています。
ここではその一つを紹介しましょう。
\mydescription{
\item[セットアップ]
楕円曲線上の点$P$と整数$x$, $y$をランダムに決めて
\[
Q:=xP, \quad R:=yP
\]
とする。$(P, Q, R)$が公開鍵で$(x,y)$が秘密鍵となる。
\item[署名]
$r$をランダムにとりメッセージ$m$に対して
\[
S:=\frac{1}{x+m+yr}P
\]
を計算し$(S,r)$を署名とする。
\item[検証]
公開鍵$(P, Q, R)$と署名$(S,r)$に対して
\[
e(S,Q+mP+rR) \eqq e(P, P)
\]
が成立すれば署名を受理する、そうでなければ棄却する。
}
正しい署名を検証した場合は、
\begin{align*}
e(S,Q+mP+rR)&=e(\frac{1}{x+m+yr}P,xP+mP+ryP)\\
&=e(\frac{1}{x+m+yr}P,(x+m+yr)P)\\
&=e(P,P)
\end{align*}
により検証が通ります。
この署名は\ref{SDH}節で紹介する$n$-SDH仮定のもとで安全であることが示されています。

\section{この章のまとめ}
ペアリングと呼ばれる楕円曲線の2点から有限体のある値が決まる関数を紹介しました。
この関数は片方の点を2倍にすると関数の値が2倍になる性質があります。
この性質を双線形といいます。

ペアリングを使うとIDベース暗号を構成できます。
IDベース暗号はユーザの好きな文字列（ID）を公開鍵にできる暗号方式です。
ペアリングはIDベース暗号の他にもデジタル署名やこれから紹介する様々な暗号の構成に使われます。
