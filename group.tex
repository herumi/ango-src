\chapter{群}
この章はやや抽象的な話をします。
有限体上のElGamal暗号と楕円ElGamal暗号は異なる式ですが、なんとなく似ていました。
この「似ている」という感じを抽象化すると群上の演算というものにたどりつきます。
また楕円離散対数問題は$P$, $Q(=nP)$が与えられたときに$P$を何倍すれば$Q$になるのかという問題でした。
「何倍か」という問いなのに、「対数」という名前が入っているのが気持ち悪いかもしれません。
群の概念を理解するとその気持ち悪さも解消されると思います。

\section{演算の抽象化}
群とは足し算や掛け算といった演算の抽象化です。
演算の抽象化とは聞き慣れないですが普段意識しないところでしています。
たとえば1個50円のお菓子を4個買うときは、
\[
50 \times 4 = 200
\]
と計算して200円と求めます。
また縦50cmで横4cmの長方形の面積は、
\[
50 \times 4 = 200
\]
と計算して200cm${}^2$と求めます。
お菓子の金額と面積とは異なる概念です。
それなのに同じ計算式で200という値を計算しています。
これはよく考えると不思議です。
なぜ本来は別のものなのに同じ演算で記述できるのでしょう。

これはお菓子の金額を1円玉が何個あるか、また面積を一辺1cmの正方形が何個あるか、
と考えることで、「○個あるか」という問いに答えるために計算手段を抽象化しているからです。
そもそも50円と50cmという違うものを同じ50という値で表しているのも抽象化の一つです。

余りの世界では足し算や引き算を「足したり引いたりしてから余りをとる」という操作で定義しました。
最初は${}\pmod p$を書いていましたが、慣れてくるといちいち${}\pmod p$を書かなくても$+$や$-$を見たときに余りの計算とみなせるようになりました。
また割り算は普通の整数の世界と異なる方法で導入しました。
ただその割り算に対して$/$という普通の割り算と同じ記号を使っても違和感はありませんでした。
そうするとそもそも足し算や引き算とはなんなのか、どういう性質を持っていたら足し算と思えるのかという問いが生まれます。
その問いに対する答えの一つが群です。
群とは掛け算（あるいは足し算）が満たすべき性質を最小限に絞って抽象化したものなのです。
\section{群の定義}
\label{group}
それでは群の定義から始めましょう。
前節で触れたように群とは足し算や掛け算のみに着目してそれを抽象化した概念です。
一般に、ある集合$G$の2個の元に対してその集合の元を対応させる写像$\mu$を（2項）演算といいます。
\[
\begin{array}{cccc}
\mu:& G \times G       & \longrightarrow & G                     \\
&\rotatebox{90}{$\in$} &                 & \rotatebox{90}{$\in$} \\
&(x,y)                 & \longmapsto     & \mu(x, y).
\end{array}
\]
集合$G$上の演算$\mu : G \times G \rightarrow G$が次の性質を満たすとき$G$は演算$\mu$に関して群であるといいます。
記号の簡略化のため、$\mu(x, y)$を$x \cdot y$と書きます。
\begin{itemize}
\item[] \textbf{結合則}：任意の$x$, $y$, $z \in G$に対して$(x \cdot y) \cdot z = x \cdot (y \cdot z)$。
\item[] \textbf{単位元}：単位元$e \in G$と呼ばれるものが存在して任意の$x \in G$に対して$x \cdot e = e \cdot x = x$。
\item[] \textbf{逆元}：任意の$x \in G$に対して$x$の逆元$x^{-1} \in G$と呼ばれるものが存在して$x \cdot x^{-1} = x^{-1} \cdot x = e$。
\end{itemize}

結合則は実数の足し算や掛け算について$a+(b+c)=(a+b)+c$や$a(bc)=(ab)c$が成り立っていたことを群にも要求しています。
単位元は演算が足し算なら$0+a=a+0=a$、掛け算なら$1 \cdot a = a \cdot 1 = a$を意味します。
逆元は足し算なら$-a$, 掛け算なら$1/a$です。

$G$の元の個数が有限個のとき有限群といいます。そのときの群の元の個数を位数（いすう）といい$|G|$と書きます。
具体例を挙げます。
実数全体の集合$\RR$上の足し算は2項演算です。
つまり$x$, $y \in \RR$に対して$\mu(x, y):=x+y \in \RR$です。
$\RR$は足し算に関して群となります。
なぜならまず任意の$\RR$の元$x$, $y$, $z$に対して結合法則$(x+y)+z=x+(y+z)$が成り立ちます。
$0 \in \RR$は単位元で任意の$x$に対して$x+0=0+x=x$です。
そしてその符号を反転させた$-x$が$x$の逆元であり、$x +(-x)=(-x)+x=0$が成り立つからです。
同様に有限体$\FF_p$も足し算に関して群となります。$\FF_p$は元の数が有限個なので有限群です。

$\RR$は掛け算に関しては群にはなりません。
$\mu(x, y):=xy$とすると結合法則が成り立ち、任意の$x$に対して$x \cdot 1 = 1 \cdot x = x$ですが、0の逆元（逆数）は存在しないからです。
しかし$\RR$から0を取り除いた集合$\RR^*:=\RR \setminus \set{0}$は掛け算に関して群になります。1が単位元です。
同様に有限体$\FF_p$は掛け算に関して群にはなりませんが、0を除いた集合${\FF_p}^*:=\FF_p\setminus\set{0}$は掛け算に関して群となります。
楕円曲線上の点の集合も足し算に関して群となります。
点$P$に原点$O$を足しても値は変わらないので$O$が単位元です。$P+O=O+P=P$.
点$P$の逆元はそのベクトルの向きを逆にしたものでした。$P+(-P)=(-P)+P=O$.
これが逆元に相当します。
楕円曲線上の点同士の演算には掛け算に相当するものはありません。

これらの例はどれも2項演算$\mu$に対し全ての$x$, $y$について
\[
\mu(x,y) = \mu(y,x)
\]
という関係が成り立っていました。
このような関係が成り立つ演算を可換（かかん）であるといいます。
群の演算が可換なとき可換群とか加法群といいます。

可換でない群の例として逆行列を持つ2行2列の実正方行列全体$\text{GL}_2(\RR)$があります。
$\text{GL}_2(\RR)$は行列の掛け算に関して群となります。単位元は
\[
I_2:=\matt{1}{0}{0}{1}
\]
です。行列の積は
\[
A:=\matt{a}{b}{c}{d}, \quad
B:=\matt{p}{q}{r}{s} \text{ について }
AB := \matt{ap+br}{aq+bs}{cp+dr}{cq+ds}.
\]
逆元は
\[
A^{-1}:=\frac{1}{ad-bc}\matt{d}{-b}{-c}{a}.
\]
行列$A$, $B$に関して常に$AB=BA$が成り立つとは限りません。

\section{巾乗}
もう少し抽象的な話が続きます。
（可換とは限らない）群$G$があると結合則により任意の$x \in G$に対して$(x \cdot x) \cdot x = x \cdot (x \cdot x)$が成り立ちます。
つまり
\[
x \cdot x \cdot x
\]
を考えたとき、この値は前から先に演算しても後ろから先に演算しても同じであることを示しています。
結果が演算の順序に依存しないので括弧を省略しても曖昧にはなりません。
これを$x^3:=x \cdot x \cdot x$と書くことにしましょう。
次に4個の$x$の演算
\[
x \cdot x \cdot x \cdot x
\]
を考えます。
これもどこから先に演算するかで様々な組み合わせがありますが、結合則によりどの場合も最終的な演算結果は同じになります。
たとえば
\[
((x \cdot x) \cdot x) \cdot x = (x \cdot x) \cdot (x \cdot x) = x \cdot (x \cdot (x \cdot x)).
\]
括弧を省略して$x^4:=x \cdot x \cdot x \cdot x$と書きましょう。
一般に$n$個の$x$の演算を
\[
x^n := \underbrace{x \cdot x \cdot \cdots \cdot x}_{n回演算する}
\]
と書き$x$の$n$乗と呼びます。
$x^0=e$（単位元）、$n$がマイナスのときは$x^n:=(x^{-1})^{-n}$と定義しましょう。
これらの演算や記号は実数などにおける巾乗の自然な類推です。

楕円曲線上の演算は点の足し算でした。
このときは$\cdot$の代わりに$+$を使うので点$P$を$n$回演算するときは$P^n$ではなく$nP$と書くことが多いです。
群の演算をどういう記法で表すかの違いだけで点（元）同士の演算を繰り返ししているのは同じであることに注意してください。

\section{巡回群}
\label{cyclic}
巾乗を定義したので巾乗の元が作る集合を考えてみます。
群$G$の元$g$を一つとり、$\gen{g}:=\Set{g^i|i \in \ZZ}$とします。
この集合は元の群の演算に関して群になります。群の定義を見ながら確認しましょう。
まず結合則は$G$で成り立っているので部分集合である$\gen{g}$でも成り立ちます。
$\gen{g}$は単位元$g^0=e$を含んでいます。
任意の$g^i$に対してその逆元$g^{-i}$も$\gen{g}$の元です。
よって$\gen{g}$が群であることを確認できました。
また任意の$g^i$, $g^j$について$g^i \cdot g^j = g^{i+j}=g^j \cdot g^i$ですから、元の群$G$が非可換群であっても$\gen{g}$は可換群となります。
$\gen{g}$を巡回群、$g$を$\gen{g}$の生成元といいます。

$G$が有限群のときは$\set{g^0, g^1, g^2, \dots}$も有限集合のはずです。
ということはこれらの値がのどれかは同じ値になります。
つまり$g^i=g^j$となる2個の異なる$i$と$j$が存在します。
もし$i < j$なら$i$と$j$を入れ換えることで$i > j$とします。
すると等式の両辺に$g^{-j}$をかけると$g^{i-j}=e$となります。
$s:=i-j > 0$とおくと$\gen{g}=\set{g^0, g^1, \dots, g^{s-1}}$であることが分かりました。
無限回巾乗しているつもりでしたが、実は途中で単位元にもどってぐるぐる回っていたということですね。
巡回群のイメージができたでしょうか。

${\FF_7}^*=\set{1,2,3,4,5,6}$について$x=1, \dots, 6$に対して$\gen{x}$を計算してみましょう。
\begin{center}
\begin{tabular}{|c||c|c|c|c|c|c|c|}
\hline
$x$＼$i$& 1 & 2 & 3 & 4 & 5 & 6 \\\hline\hline
1  & 1 & 1 & 1 & 1 & 1 & 1 \\\hline
2  & 2 & 4 & 1 & 2 & 4 & 1 \\\hline
3  & 3 & 2 & 6 & 4 & 5 & 1 \\\hline
4  & 4 & 2 & 1 & 4 & 2 & 1 \\\hline
5  & 5 & 4 & 6 & 2 & 3 & 1 \\\hline
6  & 6 & 1 & 6 & 1 & 6 & 1 \\\hline
\end{tabular}

$\gen{x}$の表
\end{center}
${\FF_7}^*$の部分集合$\gen{1}=\set{1}$は要素が1しかありませんがこれも群です。
$1 \cdot 1 =1$ですし1の逆元は1です。
単位元のみからなる一番簡単な群です。

$\gen{2}=\set{1,2,4}$は3個の元からなる群です。
$2^2=4$, $4^2=2$, $2 \cdot 4 = 1$です。
$\gen{4}$や$\gen{6}$も$\gen{2}$と同じ巡回群になります。
$\gen{3}$や$\gen{5}$は全部の値がでて${\FF_7}^*$となっています。
一般に有限体${\FF_p}^*$の生成元となる要素を原始元といいます。

$\gen{6}=\set{1,6}$は要素が2個の群です。
$1 \cdot 6=6$で$6 \cdot 6=1$なので$6^{-1}=6$です。
これは単位元とそうじゃない元一つからなる群ですね。

このように生成元によっていろいろな形の巡回群ができます。

\section{群に対する離散対数問題}
巡回群の説明が終わったのでようやく暗号の話に戻れます。
有限群$G$に対してその元$g$を一つとり巡回群$\gen{g}$を考えます。
$h \in \gen{g}$が与えられたときに$h=g^n$となる$n$を求める問題を巡回群$\gen{g}$に関する離散対数問題といいます。

暗号の論文では$G$を取り直して最初から巡回群であるとしていることも多いです。

有限体の演算と楕円曲線上の演算を並べてみましょう。
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
対象物        &  有限体（$\FF_p$）           & 楕円曲線（$E$）\\\hline\hline
演算          & 掛け算（$g \cdot h$）        & 足し算（$P+Q$）\\\hline
整数$n$に対して& $g$の$n$乗（$g^n$）         & $P$の$n$倍（$nP$）\\\hline
離散対数問題  & $g$と$g^a$から$a$            & $P$と$aP$から$a$\\\hline
CDH問題       & $g$と$g^a$と$g^b$から$g^{ab}$& $P$と$aP$と$bP$から$abP$\\\hline
\end{tabular}

有限体と楕円曲線の比較
\end{center}
表にすると有限体での掛け算は楕円曲線の足し算、有限体での$n$乗算は楕円曲線上の$n$倍算に対応していることが分かります。
有限体と楕円曲線という別のものであっても、群という抽象的な枠組みで考えると、ある巡回群上の離散対数問題を扱っているという観点では同じなのです。
これが、楕円曲線上でも離散"対数"問題と呼ばれている理由です。

こういう抽象化はどういうメリットがあるのでしょう。
ある暗号を巡回群の上で構成できたなら、
その巡回群として具体的に有限体や楕円曲線を選ぶことでいろいろな実装を用意できます。
新たに巡回群になるものを見つければ別の暗号を構成できるわけです。
実際、超楕円曲線やアーベル多様体という別の数学的な対象物を巡回群と見て暗号を構成できます。

超楕円曲線を使うと楕円曲線よりも鍵サイズの小さい暗号を構成できることが知られています。

\section{離散対数問題に対する攻撃}
\label{rho-method}
この節ではPolard（ポラード）の$\rho$法\index{ろーほう@$\rho$法}といわれる攻撃方法を紹介します。
これはほぼ一般の巡回群の離散対数問題に対して可能な攻撃方法です。
総当たり攻撃の計算量が$O(\text{巡回群の位数})$であるのに対して、この攻撃の計算量は$O(\sqrt{\text{巡回群の位数}})$です。

有限体上の離散対数問題に対してはもっと効率のよい方法が提案されています。
しかし、楕円曲線上の離散対数問題に対してはこれよりよい方法は今のところ知られていません。
楕円曲線暗号の鍵サイズが有限体上の暗号に比べて小さくできる理由の一つです。

加法に関するある巡回群$G:=\gen{P}$とその点$Q \in G$が与えられたとします。
$Q = aP$となる$a$を見つけましょう。

分割数と呼ばれる自然数の固定パラメータ$m$を一つ決めます。
$m$個の整数の組$(u_i, v_i)$をランダムに選び、
\[
M_i:=u_i P + v_i Q
\]
とします。
$G$の点を動かす関数$f:G \rightarrow G$を
\begin{align*}
&f(R):=R + M_{g(R)},\\
&g(R):=(R\text{から一意に決まるある整数値}) \bmod {m}
\end{align*}
とします。
関数$g$は点から$0, \dots, m-1$への適当に分布する関数なら特になんでもかまいません。
たとえば楕円曲線上の点ならその座標を使います。
それ以外の群であってもそれぞれの群に応じて適切に作ることができるでしょう。
このようにして作った$f$をランダムウォーク関数と呼びます。

点$R_0=P$とし、$R_{i+1}=f(R_i)$と$R_i$に繰り返し$f$を適用して点の集合列$X:=\Set{R_i}$を作ります。
\begin{align*}
R_0 &= P,\\
R_1 &= P + M_{i_0},\\
R_2 &= P + M_{i_0} + M_{i_1},\\
&\vdots
\end{align*}
と$M_i$を一つ選んで次々と足していくことになります。
$M_i$の定義から各$R_i$は$P$と$Q$の線形和の形をしています。
つまり$a_i$, $b_i \in \ZZ$として
\[
R_i=a_i P + b_i Q
\]
とかけます。
$X$に$R_i$を追加して更新するとき、$X$に$R_i=R_j$となる$j < i$が見つかったとしましょう。
そのとき
\[
R_i=a_i P + b_i Q = a_j P + b_j Q=R_j
\]
です。
すると
\[
Q = \frac{a_i - a_j}{b_j - b_i}P
\]
となって離散対数問題が解けました（運悪く$b_i=b_j$だったときはやり直します）。
\begin{figure}[H]
  \centering
  \includegraphics{img/rho.pdf}
  \caption{$\rho$法による$R_i$の点列のイメージ}
  \label{rho}
\end{figure}
このアルゴリズムは集合$X$にランダムに点を増やして、たまたま$X$の中に同じ点が見つかるまで繰り返します。
\ref{hash}節のハッシュ関数のところで紹介したように、見つかるのに必要なステップ数は$O(\sqrt{G\text{の位数}})$です。
$\rho$法と呼ばれる名前の由来は、$\rho$の字の形がしっぽのところから登ってぐるぐる回っているうちに同じところに衝突した図を表しているからだそうです。

\section{巡回群の位数}
\label{order_cyclic}
この節では巡回群の位数が合成数の場合、DLPが解きやすくなることを示します。
このため同じビット長の位数の巡回群を使うなら、素数位数の巡回群であることが望ましいです。

加法巡回群$G:=\gen{P}$の位数が$n:=ab$（$a$と$b$は互いに素な自然数）とします。
$Q := xP \in G$をとります。
$x$を今から求めます。

$aP$は$b$倍すると単位元になるので$\gen{aP}$の位数は$b$です。
$\gen{aP}$の中で$aP$に対する$aQ$のDLPが解けたとしましょう。
つまりある$x_1$が見つかって$aQ=x_1(aP)$。$Q=xP$より
\[
x_1(aP) = aQ = axP, \quad \text{つまり} a(x_1-x)P=0.
\]
$P$の位数が$n=ab$なので
\[
a (x-x_1) \equiv 0 \pmod{ab}.
\]
$a$と$b$は互いに素なので$a$で割って$x-x_1 \equiv  0\pmod{b}$。
つまりある整数$k$があって
\[
x = x_1 + bk
\]
と表せます。
同様に$\gen{bP}$の中で$bP$に対する$bQ$のDLPが解けて$x_2$が見つかると
\[
x_2 (bP) = bQ = bxP.
\]
つまり$x \equiv x_2 \pmod{a}$となり、ある整数$h$があって
\[
x = x_2 + ah
\]
と表せます。

$a$と$b$が互いに素なので\ref{calc_field_inv}節で紹介する拡張Euclidの互除法を使うことで
\[
sa + tb = 1, \quad \text{つまり} sa=1-tb
\]
となる整数$s$と$t$が見つかります。
\[
x = x_1 + bk = x_2 + ah, \quad \text{つまり} x_1 - x_2 = ah - bk.
\]
よって
\begin{align*}
&s(x_1-x_2)=s(ah-bk) = sah - sbk = (1-tb)h - sbk = h - (th+sk)b \quad \text{つまり},\\
&h = s(x_1-x_2)+(th+sk)b.
\end{align*}
よって
\[
x = x_2 + ah = x_2 + a(s(x_1-x_2) + (th+sk)b)=x_2 + as(x_1-x_2) + (th+sk)ab.
\]
よって
\[
x \equiv x_2 + as(x_1-x_2) \pmod{ab}
\]
と$x$を求めることができます。
位数$ab$のDLPは位数$a$のDLPと位数$b$のDLPを解くと求められることが分かりました。

もし位数$n$のDLPを解く演算量が$O(\sqrt{n})$で、$n=ab$の$a$, $b$が同じぐらいだったとします。
すると$a \simeq b \simeq \sqrt{n}$です。
それぞれのDLPを解く演算量は$O(\sqrt{a})=O(\sqrt{\sqrt{n}})$です。
つまり$n$が素数ならDLPの演算量は$O(\sqrt{n})$なのに、$a$, $b$それぞれで解けるなら演算量は$O(2n^{1/4})$とずっと小さくなります。

また素数巾の形$p^e$の位数を持つDLPも$p$位数のDLPを解くことに帰着できることも知られています。
つまり位数が素因数分解できればできるほどDLPが容易になります。
有限体$\FF_p$のDLPの場合、\ref{fp_size}節で示すように巡回群の位数は$p-1$の約数です。
2以外の素数は奇数なので$p-1$は必ず偶数です。
よって暗号で使われる素数は$p-1=2 \times \text{素数}$という形であることが望まれます。

\section{この章のまとめ}
足し算や掛け算の抽象化である群という概念を紹介しました。
有限体上の暗号と楕円曲線上の暗号は巡回群で考えると同じ式で記述できます。
離散対数問題の解きやすさを考えると巡回群の大きさは素数であることが望ましいです。
