\chapter{楕円曲線暗号}
\label{chap:ec}
この章では楕円曲線暗号について紹介します。
楕円曲線暗号は同程度の安全性を持つ有限体上の暗号に比べて鍵サイズが小さいという特徴があります。

楕円曲線暗号は住民基本台帳カードなどのICカードや、パソコンでGoogleやTwitterなどのサービスを利用するときに使われています。
新しい暗号通貨、仮想通貨として話題になったビットコインにも楕円曲線を使った電子署名が使われています。
近い将来キャッシュカードなどでも使われるようになるでしょう。

この章ではイメージしやすいように、楕円曲線の幾何学的な描写を重視して説明します。
暗号の計算で使いやすい代数的な側面については\ref{part:math}部で紹介します。

\section{楕円曲線暗号}
\label{sec:ec_crypto}
楕円曲線暗号とは楕円曲線上で組み立てられた暗号プロトコル全般のことを指します。
楕円曲線は実現したい暗号プロトコルの手段の一つです。
公開鍵暗号や共通鍵暗号といった実現したい機能を表すグループの名称とは「暗号」の使い方がやや異なるので注意してください。
「楕円曲線を使った暗号」というニュアンスです。

楕円曲線についてはこれからゆっくりと説明します。
なお、楕円という言葉が入っていますが中学校や高校で習う円がつぶれた形の楕円とは違います。
楕円曲線という一つの用語です。

今までにいろいろな暗号プロトコルが出てきたので整理するためにまとめてみました。
図\ref{fig:protocol.pdf}は実現したい機能（横軸）と、実現手段（縦軸）の2軸で示しています。
「鍵共有」や、「公開鍵暗号」など長方形の枠で囲ったものが機能面の名前、左の縦に使っている主な道具で分けています。
有限体を使った暗号と楕円曲線を使った暗号はほぼ対応していることが分かります。
後半の章で紹介するペアリングを使うとそれらとは違う機能を実現できます。
\image{protocol.pdf}{機能と道具の観点からみた主な暗号プロトコル}
まだ説明していない用語やこのテキストでは紹介しないものも含んでいます。
もちろんこの枠に入らない暗号もたくさんあります。
また、ある機能を持つ暗号がその道具を使わないとできないというわけでもありません。

\section{2次元の世界へ}
それでは楕円曲線のはなしに入ります。
ElGamal暗号は有限体を使って構成されていました。
有限体$\FF_p$の世界は数直線上を$p$進むと元に戻ります。
これは0と$p$のところをつなげると円周をぐるぐる回っていることになります。
円周という線の上を動いているので1次元の世界です。
\image{circle.pdf}{$\FF_p$上の加算は円周をぐるぐる回っている}
これを2次元にすると別の暗号を作れるでしょうか。
1次元では円周だったので2次元ならビーチボールのような球面を考えればよさそうです。
ちょっと考えるとぐるぐる回ってうまくいきそうに思います。
しかし残念ながら実は球面上ではうまくいかないことが知られています。
もう少し数学的にいうと2次元球面にはきれいな足し算の構造を入れられないのです。
「きれいな足し算の構造」を厳密に説明するのはこのテキストの範囲を超えるため省略しますが感覚的な説明をしましょう。

球面状にきれいな足し算の構造が入ったとします。
ある点にとても小さな値を少しずつ足していきます。
すると球面の上を点が少しずつ動いてその軌跡は水の流れのようなものになります。
しかし、どう流れを作ってもどこかに涌きだし口や渦のような吸い込み口という特殊な点ができてしまします。
これはHairy ball（毛玉）の定理という幾何学の定理により示されています。
球面を頭、水の流れを髪の毛にたとえると、特別な点は頭のつむじに相当します。
頭には（髪の毛があれば）つむじが必ずあるという定理です。
\image{sphere.pdf}{球面と浮輪の上の水の流れ}
そしてその特別な点ではきれいな足し算の構造が壊れることが示されます。
したがって球面上にはきれいな足し算の構造を入れられません。
球面ではなく浮輪の表面だと涌きだし口や吸い込み口のない水の流れを作れます。
つまりきれいな足し算の構造が入ります。

\section{ドラクエ3の世界}
\label{torus}
きれいな足し算の構造が入る2次元の世界を考えるとき、球面では駄目で浮輪の表面だとうまくいくのでした。
でも浮輪の表面で足し算ってイメージしにくいですね。

ここで唐突ですがドラゴンクエストというゲームを紹介します。
ゲームのキャラクターたちは長方形の世界地図の中を移動します。
パッと見ると普通の世界地図なのですが、右へ進んで右端に来ると左端から出てきます。
上に進んで上端に着くと下端から出てきます。
\image{dq3.pdf}{ドラクエ3の世界地図}
これは、この惑星？がもし3次元空間の中に存在していたら、どんな形をしているでしょう。
右端と左端が同じなのでくっつけると円筒になります。
メルカトル図法による普通の世界地図の両端をくっつけたのとそっくりです。
ただ世界地図と違ってドラクエ3では上端と下端も同じなので、それらもくっつける必要があります。
\image{dq3-2.pdf}{ドラクエ3の世界地図の端を張り付ける}
すると（多少曲げないといけませんが）浮輪の表面の形になります。
なんとドラクエは球面ではなく、浮輪の表面の世界だったのです。
浮輪の表面を数学の言葉でトーラス（torus）といいます。
トーラス上の足し算は分かりにくくてもドラクエ世界上の足し算は容易に考えられます。
世界を長方形$OABC$とします。
\image{elliptic.pdf}{トーラス上の足し算}
2点$P$, $Q$に対してその足し算$P+Q$を点$P$から$\overrightarrow{OQ}$だけ進めということにします。
つまり$O$, $P$, $P+Q$, $Q$が平行四辺形になるように$P+Q$を決めます。
そのとき、$P+Q$が長方形$OABC$をはみ出たら回り込ませます。
点$P$から$\overrightarrow{OQ}$だけ進んでも、逆に点$Q$から$\overrightarrow{OP}$だけ進んでも同じ場所にたどり着きます。
つまり
\[
P+Q=Q+P
\]
です。$-P$は$P$と反対方向の点としましょう。
このようにして両端がつながった長方形の世界、つまりトーラス上に足し算を定義できます。

足し算の入ったトーラスを楕円曲線といいます。
数学的には楕円曲線はトーラスとは別のもので定義されます。
しかし、実は根っこでトーラスと同じものであることが分かっています。
\ref{part:math}部の\ref{chap:ec_math}章でその関係を紹介します。

足し算ができるのならある点$P$の整数倍も考えられます。
$nP$を$P$を$n$回足すことで定義します。
\[
nP := \underbrace{P + P + \cdots + P}_{n回足す}
\]
$n$倍の計算は有限体のときの巾乗の計算と同様にバイナリ法（\ref{binary-method}節参照）を使うことで効率よく求められます。

\section{楕円離散対数問題}
楕円曲線上でゲームのキャラクターが歩き回ることを考えましょう。
\image{ec_walk.pdf}{楕円曲線上を歩く}
キャラクターの一歩が$P$だとします。
原点から2歩歩くと$2P$の位置にいます。
どんどん進んで端に到達すると逆から出てきます。
10歩でも100歩でも$10^{100}$歩でも進めます。
そして歩いて到達した位置$10P$や$100P$、$10^{100}P$は容易に求められます。

さて、移動していたキャラクターはうっかり何歩歩いていたか忘れてしまいました。
現在地と自分の一歩から何歩歩いたのか知りたいのです。
実はこれはとても難しいことが知られています。
一歩$P$が決まっているときに
\[
\text{歩数$n$から現在地$nP$を求められる} \leftrightsquigarrow \text{現在地$nP$から$n$を求められない}
\]
有限体のときと同じく、この非対称性が重要です。

「$P$, $nP$が与えられたときに$n$を求めよ。」

という問題を楕円離散対数問題（ECDLP : Elliptic Curve DLP）といいます。
楕円曲線暗号はECDLPが難しいことを仮定して構成されます。
$nP$と$P$から$n$を求めるのだから除算問題じゃないのか、なぜ対数と呼んでいるのかという疑問をもたれるかもしれません。
それについては\ref{group}章で説明します。

\section{楕円DH鍵共有と楕円ElGamal暗号}
楕円曲線暗号の中で基本的な楕円DH（ECDH：Elliptic Curve DH）鍵共有を紹介しましょう。
\ref{seq:dh-sharing}節で紹介したDiffie-Hellman鍵共有の楕円曲線版です。
\begin{enumerate}
\item $P$を固定する（これは公開情報です）。
\item Aさんは秘密の数字$a$を決めて$K_A := aP$を計算して公開する。
\item Bさんは秘密の数字$b$を決めて$K_B := bP$を計算して公開する。
\item Aさんは$a$と$K_B$を使って$a{K_B} = abP$を計算する。
\item Bさんは$b$と$K_A$を使って$b{K_A} = abP$を計算する。
\end{enumerate}
これにより二人の間で秘密の数値を共有できます。
盗聴者は$P$, $aP$, $bP$を知りますが、それから$a$や$b$を求められないので$abP$が分かりません。
有限体のときと同様、正確には楕円DH問題

「$P$, $aP$, $bP$が与えられたときに$abP$を求めよ。」

が困難であるとき、この鍵共有は安全に行えます。

同様に有限体上のElGamal暗号を楕円曲線上に焼き直した楕円ElGamal暗号も作れます。
\mydescription{
\item[鍵生成]
楕円曲線$E$とその上の点$P$を固定してみなに公開する。
ユーザAは整数$a$をランダムに選び$K_A := aP$とする。
$a$が秘密鍵で$K_A$が公開鍵である。
\item[暗号化]
平文$M$を$E$の点として表現する（たとえば楕円曲線の点の$x$座標に入れる）。
整数$r$をランダムに選び公開鍵$K_A$を用いて
\[
\Enc(M) := (rP, M + rK_A)
\]
とする。
\item[復号]
$(C_1, C_2):=\Enc(M)$を受け取った人は
秘密鍵$a$をもつ人は
\[
\Dec(C_1, C_2) := C_2 - aC_1
\]
として平文を復号する。
}
正しく復号できることは
\[
\Dec(\Enc(M))=\Dec(rP, M+rK_A)=(M+rK_A)-a(rP)=M+raP-arP=M
\]
から分かります。
\section{楕円曲線暗号の利点}
\label{comp_ec_rsa}
1次元のような有限体から2次元の世界を考えることで楕円曲線暗号にたどり着きました。
楕円曲線は普通の有限体上の暗号に比べて鍵のサイズが小さくてよいという利点があります。

両暗号が同程度の安全性を持つときの鍵のビット長を『楕円曲線暗号とRSA暗号の安全性比較』（富士通株式会社）~\cite{FUJITSU2010}をもとに表\ref{tab:compare}にしました。
なお、鍵長の対応は絶対的なものではなく評価方法や時代によっても変わります。
大まかな目安と考えてください。
\tablecap{同じ安全性のRSA暗号、楕円曲線暗号、共通鍵暗号の鍵のビット長の比較}{
\begin{tabular}{|c|c|c|c|c|c|}
\hline
RSA暗号      & 1024 & 1219 & 2048 & 2832 & 11393 \\\hline
楕円曲線暗号 & 138 & 152  & 206 & 245 & 497 \\\hline
共通鍵暗号   & 72  & 80   & 108 & 128 & 256 \\\hline
\end{tabular}
\label{tab:compare}
}
1024ビットのRSA暗号は近い将来解読されると推測されています。
したがって現在は2000ビット以上のRSA暗号が推奨されています。
高い安全性が要求されると必要な鍵長の差は広がり、楕円曲線暗号の利点が大きくなります。
これはRSA暗号や有限体上の暗号に使われる効率のよい攻撃アルゴリズムが楕円曲線暗号には使えないからです。
国家安全保障局（NSA）が利用する暗号リストSuite BにはRSAを使ったアルゴリズムは含まれていません~\cite{SUITEB}。

\section{ECDSA}
楕円曲線を使うと暗号の他にデジタル署名も作れます。
\ref{dsa}節で紹介した有限体上のデジタル署名DSAの楕円曲線版を紹介しましょう。
暗号通貨、仮想通貨という名前で有名になったビットコインは256ビット長のECDSAを利用しています~\cite{bitcoin}。
\mydescription{
\item[鍵生成]
楕円曲線$E$と点$P$と整数$x$をランダムに選び$Q:=xP$とする。
$q:=\min \Set{n|nP=0,n>0}$とし、ハッシュ関数$h$を選ぶ。
$(P,Q)$を公開鍵、$x$を秘密鍵とする。
\item[署名]
整数$k$をランダムに選び$kP$の$x$座標を$r$とする。平文$m$に対して
\[
s:=(h(m)+xr)/k\bmod{q}
\]
を求めて$(r,s)$を$m$に対する署名とする。
\item[検証]
公開鍵$P$, $Q$と与えられた$m$と署名$(r,s)$に対して
\[
R:=(h(m)/s)P+(r/s)Q
\]
を計算し、$R$の$x$座標が$r$に等しいければ署名を受理し、そうでなければ棄却する。
}
正しい平文に対しては正しく受理できることを確認します。
\[
(h(m)/s)P+(r/s)Q = \frac{h(m)}{s}P+\frac{r}{s}xP=\frac{h(m)+xr}{s}P=kP
\]
となり$kP$の$x$座標は$r$に等しいです。

\section{前方秘匿性}
身近なところで楕円曲線暗号が使われている例を紹介しましょう。
AさんとBさんが秘密の通信をしています。通信内容を共通鍵暗号AESで暗号化し、AESの鍵$K$を公開鍵暗号RSAで暗号化して渡していました。
$K$はセッション毎に異なる値です。
盗聴者はその二人の間の暗号化された通信の中身を読めないけれども、ずっと記録していたとしましょう。
ある日、AとBの間で使われていた公開鍵暗号の秘密鍵が漏洩（ろうえい）してしまいました。
すると盗聴者は過去に遡って記録していた暗号文を復号し、内容を見られます。
AやBが重要な人物の場合、通信の記録が保持されていてもおかしくはありません。

このような事態になっても安全性を担保するには、ある段階で使われていた秘密鍵が漏洩したとしても、それよりも過去の暗号文を容易に復号できないようにする必要があります。
公開鍵暗号のような比較的長期に渡って使われる秘密鍵が漏洩したとしても、そのときに使われていた共通鍵暗号に使われる秘密鍵が漏洩しないようにしたいのです。
これを前方秘匿性（ぜんぽうひとくせい：Forward Secrecy：FS）といいます。
PFS（Perfect Forward Secrecy）ともいわれます。
様々な暗号に対してどのようにしたら前方秘匿性の機能を持たせられるか研究されています。

先ほどのRSA暗号で$K$を暗号化している場合はPFSは保たれません。
\image{no-pfs.pdf}{RSA暗号を用いたClientKeyExchange}
しかし毎回DH鍵共有で秘密鍵$K$を作ればRSA暗号の秘密鍵とは無関係なので解読できません。
\image{pfs.pdf}{DH鍵共有を用いたClientKeyExchange}
つまり、PFSが保たれます。
有限体上のDH鍵共有は処理が重たいためあまり使われていませんでした。
しかし、楕円DH鍵共有はRSA暗号に比べてもそれほど重たくはないため徐々に普及しています。

GoogleのGmailは2011年にPFSに対応しました。
2013年アメリカ国家安全保証局（NSA）がインターネットの通信を盗聴、保存、解析していたことが明らかになります。
当時局員だったSnowdenが告発したのです。
そのときFBIが追求のためSnowdenが利用していたメールサービス提供者に秘密鍵の提供を求めます~\cite{guardian}~\cite{ukky3}。
それにより秘密鍵が漏洩するとそれまでの通信が復号できる状況が現実的なものとして認識されます。
そのためTwitterなどの大手のサービス提供社も次々とPFSに対応しました。
\begin{figure}[H]
  \centering
  \includegraphics[scale=0.6]{img/google.png}
  \caption{2014年3月に\texttt{https://www.google.co.jp/}に接続したときの情報}
  \label{fig:google.png}
\end{figure}
FirefoxやChromeなどのブラウザで\texttt{https://www.google.co.jp/}に接続し、鍵アイコンをクリックすると接続に使われた暗号アルゴリズムを確認できます。
図\ref{fig:google.png}を見ると\texttt{ECDHE\_ECDSA}という鍵交換メカニズムが使われていることが分かります。
\texttt{ECDHE}はECDH鍵共有、
\texttt{ECDSA}は前節で紹介した楕円曲線版DSAのことです。
\texttt{ECDHE}の最後の\texttt{E}はEphemeral（一時的な、短命の）という単語を指します。
平文の暗号化に使う鍵を毎回使い捨てていることを表しています。
\section{この章のまとめ}
楕円曲線暗号とは楕円曲線を使った暗号全般を指します。
楕円曲線とは上下左右がつながった長方形世界のことです。
楕円離散対数問題（ECDLP）とは、その世界のある点に何歩歩けばたどり着けるかという問題です。

ECDLPが困難であることを利用して、鍵共有や公開鍵暗号を構成できます。
楕円曲線暗号は有限体を使った暗号に比べて鍵のサイズが小さいという利点があります。

鍵漏洩時の影響を減らす前方秘匿性の需要の高まりに応じて楕円曲線暗号の使われるシーンが増えています。
