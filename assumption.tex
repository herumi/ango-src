\chapter{ペアリングの安全性仮定}
\label{chap:assumption}
ペアリングを使った暗号プロトコルでは、様々な問題の困難さが仮定されています。
この章ではそれらのいくつかを俯瞰します。

\section{DDH仮定とDLIN仮定}
\label{dlin}
\ref{sec:ind}節でElGamal暗号が強秘匿性を持つことを紹介しました。
強秘匿性というのは暗号文からもとの平文のどんな情報もえられないという性質でした。
その強秘匿性を示すにはDDH問題が解けないというDDH仮定が必要です。
DDH問題を復習すると楕円曲線上の点$P$について、

「$P$, $aP$, $bP$が与えられ、更に$Q_1:=abP$かランダムな$c$に対する$Q_2:=cP$のどちらかの$Q_i$が与えられたとき$i$は1と2のどちらか判定せよ。」

という問題です。DDH仮定は暗号の安全性仮定で使われる基本的な仮定の一つです。
ところがペアリング暗号では使い勝手が悪いことがあります。
なぜなら$aP$と$bP$から$e(aP, bP)=e(P, P)^{ab}$が得られます。
\begin{align*}
& e(P, Q_1)=e(P, abP)=e(P,P)^{ab},\\
& e(P, Q_2)=e(P, cP)=e(P,P)^c
\end{align*}
ですから、これらの値と$e(P,P)^{ab}$を比較することでDDH問題を解けるからです（\ref{relation}節参照）。

そこでペアリング暗号ではDDH仮定を変形したDLIN仮定（Decisional LINear assumption）が使われることがあります。
それは変数が増えてちょっと分かりにくいのですが次の問題が困難であるという仮定です。

「$P$, $xP$, $yP$, $axP$, $byP$が与えられたときに$(a+b)P$とランダムな$c$に対する$cP$のどちらが与えられたか判定せよ。」


DLIN仮定はペアリングにおける基本的な仮定の一つと考えられています。
なおDDH問題について楕円曲線上の点2個からなる2次元ベクトル$(P, aP)$を考えて$b$倍すると
\[
b(P,aP)=(bP,abP)
\]
です。
つまり2点$(0,0)$と$(P,aP)$を結ぶ直線上に$(bP,Q)$があるか判定せよと解釈できます。

同様にDLIN問題は3次元ベクトル$(xP, 0, P)$と$(0, yP, P)$について適当な$a$、$b$をとり、
$Q$が$(a+b)P$とランダムな$c$に対する$cP$のどちらかのときに
\[
a(xP, 0, P)+b(0, yP, P)=(axP, byP, Q)
\]
とできるか、すなわち
3点$(0,0,0)$, $(xP,0,P)$, $(0,yP,P)$を含む平面上に$(axP,byP,Q)$があるか判定せよという問題です。
\begin{figure}[H]
  \centering
  \includegraphics{img/dlin.pdf}
  \caption{DLIN仮定の解釈}
  \label{fig:dlin}
\end{figure}

\section{パラメータつき問題}
有限体や楕円曲線のDLPやDH問題は入力値が2個や3個、ペアリングのCBDH問題は4個と入力値の個数は一定でした。
しかし、\ref{BGW}節で紹介した$l$-BDHE問題は入力値の個数が$l$によって変わりました。
このような入力値の個数がパラメータによって変化する問題をパラメータつき問題といいます。

パラメータつき問題は様々なものが提案されています。
ルーツは私たちの提案した（安全では無かった）放送型暗号のプロトコルです。
仕組みは簡単ですので紹介します。
楕円曲線上の点$P$と整数$a$を秘密に選び、各ユーザ$u$に対して
\[
K_u:=\frac{1}{u+a}P
\]
を秘密鍵として秘密裏に渡します。
整数$r$をランダムにとり、$Q:=rP$として、
$s:=e(P, Q)$をセッション鍵としてコンテンツを暗号化します。
\[
(Q, aQ)
\]
をセッション鍵の暗号化したものとして配信します。
ユーザ$u$は自身の秘密鍵$K_u$を用いて
\[
e(K_u,uQ + aQ)=e\left(\frac{1}{u+a}P, (u+a)Q\right)=e(P, Q)=s
\]
とペアリングを計算してセッション鍵を得られます。
ユーザの秘密鍵に使われるパラメータが消えて単一の$s$が出てくるこの関係式を見つけたときは、これは綺麗だと思ったものです。
最初に不正者追跡に使ってしまったのは失敗でしたが。

それはともかく、ここでユーザの部分集合$S$が結託攻撃をして
$\Set{K_{u_i}}_{u_i \in S}$に入っていないユーザ$u$に対する$K_u$を作るのは難しいだろうと感じました。
つまり
\[
「\left(\frac{1}{u_1+a}P, \dots, \frac{1}{u_n+a}P\right)が与えられたときにu \notin \Set{u_1, \dots, u_n}に対する\frac{1}{u+a}Pを求めよ。」
\]
この問題（仮に$n$-CAAと呼びましょう）は難しい。
この直感は今でも有効です（安全でなかったのはこれとは別の部分です）。

ただ発表するときに$n$-CAAが難しいから安全というのでは説得力が足りません。
2000年頃はまだペアリングを使った暗号自体が認知されていませんでした。
初めてこの方式を発表したのは、2001年3月の先端技術フォーラム（FACT）という研究集会で、
%\footnote{http://www2.tamacc.chuo-u.ac.jp/souki/hyouka/kiso-date/kikou.pdf}
これはBoneh-Franklinたちの発表でペアリング暗号が広まったCRYPTO2001が開催された2001年8月より前です。

ペアリング自体が珍しいのに、その上よく分からない安全性仮定をつけても戸惑うだけです。
そこで$n$-CCAって難しいよね、という根拠を見せなければなりません。
それにはDH問題などの既存の問題との関係を示せるとよいです。
いろいろ式をこね繰り回して納得のいくものを作ります。

\section{ちょっとしたクイズ}\label{quiz}
さて突然ですが次の問題の中で一番難しいのはどれでしょう。
\begin{itemize}
\item[I.] $P$, $aP$, $bP$から$abP$を求める。
\item[II.] $P$, $aP$から$a^2P$を求める。
\item[III.] $P$, $aP$から$(1/a)P$を求める。
\end{itemize}

Iは通常のDH問題です。IIはその特別版なのでIの方が難しそうです。
IIIは逆数版ですね。

実はどれも同じ程度の困難さなのです。まずIが解けるならIIが解けることを示します。
$P$, $aP$が与えられたとします。$b=a$として$P$, $aP$, $aP$の三つ組が与えられたとすると
Iが解けるならこれから$aaP=a^2P$が求められます。
つまりIが解けるならIIが解けます。

この逆、IIが解けるならIが解けることも示せます。
$P$, $aP$, $bP$が与えられると$aP+bP=(a+b)P$を求められます。
$(P, aP)$, $(P, bP)$, $(P, (a+b)P)$のそれぞれの組に対してIIを適用して
$a^2P$, $b^2P$, $(a+b)^2P$を求められます。すると
\[
(a+b)^2P-a^2P-b^2P=2abP
\]
が分かり2で割って$abP$を求められます。つまりIが解けました。

というわけでIの難しさとIIの難しさは同程度だと分かりました。
最後にIIが解けるとIIIが解けることを示します。
$P$, $aP$が与えられたとき、これを$(aP)$, $(a^{-1})(aP)$が与えられたとみなします。
するとIIを使うと$(a^{-1})^2(aP)=(1/a)P$が求まり、IIIが解けました。逆も同様です。

\section{ヒントの多い問題}
\label{sec:hint}
さて、一見異なる難しさに見えたIIやIIIはDH問題と同じ難しさであることが分かりました。
IよりIIやIIIはパラメータの数が少ないのでこちらで考えます。

IIやIIIの問題、すなわちDH問題が難しいということを、与えられたデータの線形和しか作れないという解釈をしてみます。
$P$と$aP$という``ベクトル''から（多項式時間で）計算できるのは$\gen{P, aP}:=\Set{xP + y(aP)|x, y \in \ZZ}$という形だけで、
その中に$a^2P$や$(1/a)P$という``ベクトル''は入ってないというイメージです。
もちろん巡回群$\gen{P}$を考えると実際には入っていますが、計算できる範囲には含まれていないというニュアンスです。

すると$P$, $aP$から$(1/a)P$を求めるのが難しいなら、
「$P$, $aP$, $a^2P$が与えられたときに$(1/a)P$を求める問題」、
「$P$, $aP$, $a^2P$, $a^3P$が与えられたときに$(1/a)P$を求める問題」
などもヒントは増えるけれども十分難しいのではないかという気がしてきます。
2個のときはDH問題と等価なのもありがたいです。すなわち

\textbf{$n$-weak DH問題（$n$-DHI問題）}
「$P, aP, a^2P, \dots, a^nP$が与えられたときに$(1/a)P$を求めよ」

あるいは同値なことですが

\textbf{$n$-weak DH問題2}
「$P, aP, a^2P, \dots, a^nP$が与えられたときに$a^{n+1}P$を求めよ」

という問題を提起します。
そして$(n-1)$-weak DH問題は$n$-CCAと等価です。
$n$-CCAが解けるなら$(n-1)$-DH問題が解けることを示しましょう。
\[
\Set{P, aP, \dots, a^{n-1}P}
\]
が与えられたとします。$\Set{u_i}$を全て異なるとして、
$b:=a-u_0$, $Q:=(b+u_1) \cdots (b+u_n)P$
とおくと
\[
\frac{1}{b+u_j}Q=\prod_{i=1, i \ne j}^n (a-u_0+u_i) P
\]
の積の部分は$a$についての$n-1$次多項式で係数は全て既知です。
仮定より$a^iP$が与えられているので
\[
\left(\frac{1}{b+u_1}Q, \cdots, \frac{1}{b+u_n}Q\right)
\]
は全て計算できます。よって$n$-CCAが解けるなら
\[
\frac{1}{b+u_0}Q=\frac{1}{a}Q=(1/a)\prod_{i=1}^n(a-u_0+u_i)P
\]
を求められます。
\[
\prod_{i=1}^n(a-u_0+u_i)=\prod_{i=0,n}d_i a^iP,
\]
と積を展開してできる係数を$d_i$とすると、
$\Set{u_i}$は全て異なるので定数項$d_{-1}$は0ではありません。
この両辺を$a$で割ると左辺と右辺の$a-iP$（$i=0, \cdots, n-1$）がわかっているので$(1/a)P$も計算できます。
よって$(n-1)$-DH問題が解けました。\qed

逆に$(n-1)$-weak DH問題が解けるなら$n$-CCAが解けることも示せます。
これにより逆数の形の問題はDH問題の類似だとみなせます。
この解釈で私の中では逆数の形の秘密鍵の位置づけが明確になりました。
$n$-weak DH問題は今は$n$-DHI（DH Inversion）問題と呼ばれます。

\section{$n$-DHI問題と$n$-SDH問題}
逆数の形を秘密鍵に使うと\ref{OSK-BF}節とは異なる構造のIDベース暗号を構成できます。
\begin{itemize}
\item[] \textbf{鍵生成}：
楕円曲線$E$とその点$P$をとる。
$p:=|\gen{P}|$とし、ハッシュ関数$h:\Set{ID} \rightarrow \FF_p$を選ぶ。
整数$s$と点$Q \in \gen{P}$をランダムにとり$(P,s)$を秘密鍵、$(Q,sQ, g:=e(P,Q))$を公開鍵とする。
\item[] \textbf{ユーザ鍵生成}：
各ユーザ$u$に対して$h_u:=h(ID_u)$として
\[
S_u:=\frac{1}{h_u+s}P
\]
を秘密鍵として渡す。
\item[] \textbf{ユーザ$u$に対する暗号化}：
平文$m$に対して整数$r$をランダムにとり、
\[
(C_1,c_2):=(r(h_uQ + sQ), mh(g^r))
\]
を暗号文とする。
\item[] \textbf{復号}：
ユーザ$u$は暗号文$(C_1,c_2)$に対して$h$を使って$c_2/h(e(S_u,C_1))$により平文を求める。
\end{itemize}
うまく復号できることは
\[
\frac{c_2}{h(e(S_u,C_1)}=\frac{mh(g^r)}{h\left(e(\frac{1}{h_u+s}P,r(h_u+s)Q)\right)}=\frac{mh(g^r)}{h(e(P,Q)^r)}=m
\]
となることで確認できます。
この暗号（SK暗号）は2005年にChen, Chengたちにより$n$-BDHI問題（$n$-Bilinear DH Inversion）が困難な仮定のもので安全と示されます~\cite{CC}。
$n$-BDHI問題は$n$-DHI問題とペアリングを合成した形の問題です：

「$P, aP, a^2P, \dots, a^nP$が与えられたときに$e(P, P)^{1/a}$を求めよ」

$n$-DHIが解けるなら$n$-BDHIは解けます。
求めた値$(1/a)P$と$P$のペアリングをとればよいからです。
DLPとDH問題の関係のように、$(1/a)P$を直接求められなくても$e(P,P)^{1/a}$を求められる可能性はありますが、
今のところその方法は見つかっていません。

\label{SDH}
さて、2004年にBoneh、Boyenはペアリングを使った短い署名を提案します。
方式は\ref{shortSig}節で紹介しました。
この署名の安全性は前節の$n$-DHI問題を少し修正したものを根拠にしています。

「$P, aP, a^2P, \dots, a^nP$が与えられたときにある$c$に対する$\frac{1}{c+a}P$を求めよ」

これは$n$-SDH問題（$n$-Strong DH）と呼ばれています。
先程の$n$-weak DH問題は$n$-SDH問題で$c$を0に固定したと類似物とみなせます。
$c=0$じゃなくてもよいからいいから、とりあえずどれかの$c$について見つければよいと問題自体を緩くしました。
また``weak''が``strong''に変わりました。
DH問題より易い問題ので私は``weak''と名付けましたが、その問題を安全性仮定に使うときは仮定が強いです。
そのため``strong''とするのが適切だったのかもしれません。

最後に\ref{BGW}節の$n$-BDHE問題を振り返りましょう。
$n$-DH問題は与えられた``ベクトル"$P$, $aP$, \dots, $a^nP$の右隣、$n$-DHI問題は左隣の値を求める問題と解釈します。
すると$n$-BDHE問題は左右に連続する``ベクトル"が与えられたときに真ん中の値を求める問題とペアリングを合成した形にみえます。
\begin{figure}[H]
  \centering
  \includegraphics{img/bdhe.pdf}
  \caption{$n$-DHと$n$-DHIと$n$-BDHEの関係}
  \label{n-bdhe}
\end{figure}
これらの問題の派生系もいくつかあります。
一般的にできるだけ単純でよく知られた問題を安全性の根拠におくのがよいです。

\section{補助入力付きDLP}
パラメータつき問題は従来のDH問題よりも沢山の情報が付与されています。
それらの情報を使って問題を解くことはできないのでしょうか。
2006年Cheonが、ある条件を満たせば\ref{rho-method}節で紹介した$\rho$法よりも効率よく求める方法があることを示します~\cite{CJ}。
それは次の問題です。

楕円曲線上の点$P$に対する巡回群$G:=\gen{P}$の大きさを素数$p$とし、$p-1$の約数の一つを$d$とします。このとき

「$P$, $aP$, $a^dP$が与えられたとき、$a$を求めよ。」

通常の離散対数の入力$P$, $aP$の他に$a^dP$の情報が与えられているので、この問題は補助入力付き離散対数問題と呼ばれます。
この問題は$O(\sqrt{p/d}+\sqrt{d})$の計算量で求められます。
特に$d$が$\sqrt{p}$ぐらいの大きさのときは
\[
O\left(\sqrt{p/\sqrt{p}}+\sqrt{\sqrt{p}}\right)=O(2p^{1/4})=O(p^{1/4})
\]
となります。

Cheonの攻撃方法は2ステップからなります。
まず${\FF_p}^*$の生成元を$g$とします。
$e:=(p-1)/d$とし、$g_d:=g^d$, $g_e:=g^e$とおきます。
$g_d$は$e$乗すると1, $g_e$は$d$乗すると1になります。
さて、$h_1:=a^d$とおくと$e$乗すると1なので$h_1 \in \gen{g_d}$。よって
\[
h_1=g_d^{k_1}
\]
となる整数$0 \le k_1 < e$が存在します。
未知の整数$x$に対して$h_1 P = g_d^xP$という方程式を考えると、$x=k_1$がこの方程式の解です。
この解を$\rho$法と同様のやり方で探します。この計算量は$O(\sqrt{e})=O(\sqrt{p/d})$です。

次に$h_2:=g^{-k_1}a$とすると
\[
h_2^d=g^{-dk_1}a^d=g_d^{-k_1}g_d^{k_1}=1.
\]
$d$乗して1になったので
\[
h_2=g_e^{k_2}
\]
となる整数$0 \le k_2 < d$が存在します。
未知の整数$x$に対して$h_2 P = g_e^xP$という方程式を考えると、$x=k_2$がこの方程式の解です。
この解を探す計算量は$O(\sqrt{d})$です。

このとき
\[
(g^{-k_1}a)P=h_2 P={g_e}^{k_2}P=g^{ek_2}P,
\]
つまり
\[
aP=g^{k_1+ek_2}P
\]
となり$a=g^{k_1+ek_2}$が求まりました。
この演算量は$O(\sqrt{e})$と$O(\sqrt{d})$の和なので$O(\sqrt{p/d}+\sqrt{d})$です。

伊豆氏、酒見氏たちはChenのアルゴリズムと実装を改良することで2012年に160ビットの補助入力付きDLPを解いています~\cite{SHITY}。
ペアリングのパラメータつきの問題はパラメータの選び方によってはCheonの攻撃を受ける場合があるので慎重に設計しなければなりません。

\section{この章のまとめ}
ペアリングを使った暗号で使われる安全性仮定の一部を紹介しました。
DBDHやDLIN仮定が基本的です。
安全性の定義に使われる要素の数が変動するタイプのものも使われます。
そのようなタイプの問題は要素の数がかなり大きいと攻撃されやすくなることがあります。
